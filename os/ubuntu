version="${version:-22.10}"
ubuntu_url="https://cdimage.ubuntu.com/ubuntu-base/releases/"
rootfs="ubuntu-base-${version}-base-amd64.tar.gz"
[ -n "$beta" ] && rootfs="ubuntu-base-${version}-beta-base-amd64.tar.gz"
pkg_cache='/var/cache/apt'

get_supported_versions() {
  wget -q $ubuntu_url -O - | grep -oP '(?<=href=")[.0-9]+(?=/")'
}

download_rootfs() {
  local rel_type
  [ -n "$beta" ] && rel_type="beta" || rel_type="release"
  local url="https://cdimage.ubuntu.com/ubuntu-base/releases/$version/${rel_type}/$rootfs"
  wget --progress=bar:force:noscroll "$url" || die "Downloading rootfs failed"
}

extract_rootfs() {
  tar xf $rootfs -C $root --numeric-owner
}

get_kernel() {
  local kernel="$(basename $(ls /boot/vmlinuz-*))"
  [ -n "$kernel" ] || die "Kernel ($kernel) not found"
  echo $kernel
}

get_initrd() {
  local initrd="$(basename $(ls /boot/initrd.img-*))"
  [ -n "$initrd" ] || die "Initrd ($initrd) not found"
  echo $initrd
}

install_pkgs() {
  source /etc/os-release
  release=$UBUNTU_CODENAME

  # Create apt sources.list file
  mv /etc/apt/sources.list{,.orig}
  echo "deb http://archive.ubuntu.com/ubuntu/ $release main universe" > /etc/apt/sources.list
  echo "deb http://archive.ubuntu.com/ubuntu/ $release-updates main universe" >> /etc/apt/sources.list

  # Setup http_proxy if needed
  [ -n "$proxy" ] && export http_proxy="$proxy"

  # Update apt cache
  echo "Updating apt cache"
  apt update || die "apt update failed"

  # Install systemd
  echo "Installing systemd, sudo, sshd etc.."
  apt-get -y install systemd systemd-sysv kexec-tools polkitd sudo kmod locales dbus openssh-server zstd || die "Installing mandatory packages failed"
  ## From 22.10, we also need systemd-boot
  dpkg --compare-versions "$VERSION_ID" "lt" "22.10" || apt-get -y install systemd-boot

  # Install any other useful pkgs
  echo "Installing other useful pkgs"
  apt-get -y install --no-install-recommends $pkgs $extra_pkgs || die "Installing user specified packages failed"

  # Install kernel and initramfs-tools
  kernel="linux-image-virtual"
  #[ "$role" == "trex" ] && kernel="linux-image-kvm"
  #[ "$role" == "trex" ] && kernel="linux-image-generic"
  [ -n "$azure" ] && kernel="linux-image-azure linux-azure"
  echo "Installing kernel: $kernel"
  apt-get -y install --no-install-recommends $kernel initramfs-tools || die "Installing linux kernel failed"

  # Misc pkgs
  ## Azure needs walinuxagent
  #[ -n "azure" ] && apt-get -y install --no-install-recommends walinuxagent
}

cleanup_system() {
  # Use a simple apt sources.list
  echo "deb http://archive.ubuntu.com/ubuntu/ $release main" > /etc/apt/sources.list

  # Cleanup
  apt-get -y remove --purge linux-firmware
  dpkg -l | grep linux-modules-extra- | xargs -r apt-get -y remove --purge
  apt-get -y autoremove --purge
  rm -rf /var/lib/apt/lists/* /var/cache/debconf/*-old /var/log/*.log
  rm -rf /usr/share/man /usr/share/info /usr/share/lintian/overrides
  mkdir -p /usr/share/man /usr/share/info /usr/share/lintian/overrides
  find /usr/share/doc -depth -type f ! -name copyright -delete
  find /usr/share/doc -empty -delete

  # Remove machine-id
  echo > /etc/machine-id
  [ -f /var/lib/dbus/machine-id ] && echo > /var/lib/dbus/machine-id

  # disable bracketed-paste mode (enabled by readline)
  echo 'set enable-bracketed-paste off' >> /etc/inputrc

  echo
}

# vim:syntax=sh filetype=sh
